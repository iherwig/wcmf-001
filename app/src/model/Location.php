<?php
/**
 * This file was generated by ChronosGenerator wcmf-1.0.18.0001 from model.uml.
 * Manual modifications should be placed inside the protected regions.
 */
namespace app\src\model;

use app\src\model\_base\LocationBase;
// PROTECTED REGION ID(app/src/model/Location.php/Import) ENABLED START
use GuzzleHttp\Client as GuzzleClient;
use Http\Adapter\Guzzle6\Client;
use Geocoder\Provider\Nominatim\Nominatim;
use Geocoder\Query\GeocodeQuery;
// PROTECTED REGION END

/**
 * Location
 *
 * @var id
 * @var category
 * @var name (String)
 * @var user (Integer)
 * @var address (String)
 * @var website (String)
 * @var notes (String)
 * @var marker (Integer)
 * @var lat (String)
 * @var lng (String)
 * @var archived (Integer)
 * @var rating (Integer)
 * @var created (Date)
 * @var creator (String)
 * @var modified (Date)
 * @var last_editor (String)
 * @rel Rating (app.src.model.Rating, 1:n)
 * @rel Image (app.src.model.Image, 1:n)
 * @rel Category (app.src.model.Category, n:1)
 */
class Location extends LocationBase {
// PROTECTED REGION ID(app/src/model/Location.php/Body) ENABLED START
  private $rating = null;

  /**
   * @see PersistentObject::afterLoad()
   */
  public function afterLoad() {
    parent::afterLoad();
    $this->loadChildren('Rating');
    $ratings = $this->getValue('Rating');
    if (sizeof($ratings) > 0) {
      $ratingSum = 0;
      $numRatings = 0;
      foreach ($ratings as $rating) {
        $ratingSum += $rating->getValue('value');
        $numRatings++;
      }
      $this->rating = $ratingSum / $numRatings;
    }

    if (strlen($this->getValue('address')) > 0 &&
        (strlen($this->getValue('lat')) == 0 || strlen($this->getValue('lng')) == 0)) {
          $this->updateCoords();
    }
  }

  private function updateCoords() {
    $config = [
        'timeout' => 2.0,
        'verify' => false,
    ];
    $guzzle = new GuzzleClient($config);
    $adapter  = new Client($guzzle);
    $geocoder = Nominatim::withOpenStreetMapServer($adapter);
    $results = $geocoder->geocodeQuery(GeocodeQuery::create($this->getValue('address')));
    $this->setValue('lat', $results->first()->getCoordinates()->getLatitude());
    $this->setValue('lng', $results->first()->getCoordinates()->getLongitude());
    $this->getMapper()->save($this);
  }
// PROTECTED REGION END
  /**
   * Location::getRating()
   * @return Integer
   */
  public function getRating() {
// PROTECTED REGION ID(app/src/model/Location.php/Methods/getRating) ENABLED START
    return $this->rating;
// PROTECTED REGION END
  }
}
